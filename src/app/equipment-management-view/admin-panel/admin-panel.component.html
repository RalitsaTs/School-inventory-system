<div class="column-layout admin-view-layout">
  <div class="header-section">
    <h4>
      Administrator Dashboard
    </h4>
    <br />
    <h5>
      Manage user roles, equipments, equipment requests, and system reports.
    </h5>
  </div>

  <igx-tabs class="tabs">
    <!-- User Management Tab -->
    <igx-tab-item [selected]="true" class="tab-item">
      <igx-tab-header>
        <igx-icon igxTabHeaderIcon>people</igx-icon>
        <span igxTabHeaderLabel>User Management</span>
      </igx-tab-header>
      <igx-tab-content class="tab-item-content">
        <div class="users-management-section">
          <h3 class="section-title">User Management</h3>
          <h5>Manage User Roles</h5>
          <p>Assign and modify user roles in the system.</p>
          
          <igx-grid 
            [data]="users" 
            [allowFiltering]="true"
            height="400px"
            width="100%">
            
            <igx-column field="email" header="Email" [sortable]="true" [filterable]="true"></igx-column>
            <igx-column field="name" header="Name" [sortable]="true" [filterable]="true"></igx-column>
            
            <igx-column field="roles" header="Current Role" [sortable]="true" [filterable]="true">
              <ng-template igxCell let-cell="cell">
                {{ cell.value?.join(', ') || 'No Role' }}
              </ng-template>
            </igx-column>
            
            <igx-column field="emailConfirmed" header="Email Verified" [sortable]="true" [filterable]="true">
              <ng-template igxCell let-cell="cell">
                <igx-icon [style.color]="cell.value ? 'green' : 'red'">
                  {{ cell.value ? 'check_circle' : 'cancel' }}
                </igx-icon>
              </ng-template>
            </igx-column>
            
            <igx-column header="Change Role" [sortable]="false" [filterable]="false">
              <ng-template igxCell let-cell="cell">
                <select 
                  class="role-select" 
                  [value]="cell.row.data.roles?.[0] || 'User'"
                  (change)="onRoleChange($event, cell.row.data)">
                  <option value="Admin">Admin</option>
                  <option value="User">User</option>
                </select>
              </ng-template>
            </igx-column>
          </igx-grid>
        </div>
      </igx-tab-content>
    </igx-tab-item>

    
    <!-- Equipment Management Tab -->
    <igx-tab-item class="tab-item">
      <igx-tab-header>
        <igx-icon igxTabHeaderIcon>devices</igx-icon>
        <span igxTabHeaderLabel>Equipment Management</span>
      </igx-tab-header>
      <igx-tab-content class="tab-item-content">
        <div class="equipment-management-section">
          <h3 class="section-title">Equipment Management</h3>
          <h5>Manage Equipment Inventory</h5>
          <p>Add, update, and remove equipment from the inventory system.</p>
          
          <div class="equipment-actions">
            <button 
              igxButton="contained" 
              igxRipple 
              (click)="addNewEquipment()"
              class="add-equipment-btn">
              <igx-icon>add</igx-icon>
              Add New Equipment
            </button>
          </div>
          
          <igx-grid 
            #equipmentGrid
            [data]="equipment" 
            [rowEditable]="true"
            [allowFiltering]="true"
            [primaryKey]="'equipmentId'"
            (rowEditEnter)="onRowEditEnter($event)"
            (rowEdit)="onRowEdit($event)"
            (rowEditDone)="onRowEditDone($event)"
            (rowEditExit)="onRowEditExit($event)"
            height="500px"
            width="100%">
            
            <igx-column field="equipmentId" header="ID" [sortable]="true" [filterable]="true" [editable]="false"></igx-column>
            
            <igx-column field="name" header="Name" [sortable]="true" [filterable]="true" [editable]="true" [required]="true"></igx-column>
            
            <igx-column field="type" header="Type" [sortable]="true" [filterable]="true" [editable]="true"></igx-column>
            
            <igx-column field="serialNumber" header="Serial Number" [sortable]="true" [filterable]="true" [editable]="true"></igx-column>
            
            <igx-column field="condition" header="Condition" [sortable]="true" [filterable]="true" [editable]="true">
              <ng-template igxCellEditor let-cell="cell">
                <igx-select [(ngModel)]="cell.value" class="condition-select">
                  <igx-select-item value="Excellent">Excellent</igx-select-item>
                  <igx-select-item value="Good">Good</igx-select-item>
                  <igx-select-item value="Fair">Fair</igx-select-item>
                  <igx-select-item value="Damaged">Damaged</igx-select-item>
                </igx-select>
              </ng-template>
              <ng-template igxCell let-cell="cell">
                <span [class]="getConditionClass(cell.value)" class="condition-badge">
                  {{ cell.value }}
                </span>
              </ng-template>
            </igx-column>
            
            <igx-column field="status" header="Status" [sortable]="true" [filterable]="true" [editable]="true">
              <ng-template igxCellEditor let-cell="cell">
                <igx-select [(ngModel)]="cell.value" class="status-select">
                  <igx-select-item value="Available">Available</igx-select-item>
                  <igx-select-item value="CheckedOut">Checked Out</igx-select-item>
                  <igx-select-item value="UnderRepair">Under Repair</igx-select-item>
                  <igx-select-item value="Retired">Retired</igx-select-item>
                  <igx-select-item value="Unavailable">Unavailable</igx-select-item>
                </igx-select>
              </ng-template>
              <ng-template igxCell let-cell="cell">
                <span [class]="getEquipmentStatusClass(cell.value)" class="status-badge">
                  {{ getStatusDisplayText(cell.value) }}
                </span>
              </ng-template>
            </igx-column>
            
            <igx-column field="location" header="Location" [sortable]="true" [filterable]="true" [editable]="true"></igx-column>
            
            <igx-column field="isSensitive" header="Sensitive" [sortable]="true" [filterable]="true" [editable]="true">
              <ng-template igxCellEditor let-cell="cell">
                <igx-checkbox [(ngModel)]="cell.value"></igx-checkbox>
              </ng-template>
              <ng-template igxCell let-cell="cell">
                <igx-icon [style.color]="cell.value ? 'orange' : 'gray'">
                  {{ cell.value ? 'warning' : 'check_circle' }}
                </igx-icon>
              </ng-template>
            </igx-column>
            
            <igx-column header="Actions" [sortable]="false" [filterable]="false">
              <ng-template igxCell let-cell="cell">
                <div class="equipment-action-buttons">
                  <button 
                    igxButton="outlined" 
                    igxRipple 
                    (click)="deleteEquipment(cell.row.data)"
                    title="Delete Equipment">
                    <igx-icon>delete</igx-icon>
                  </button>
                </div>
              </ng-template>
            </igx-column>
          </igx-grid>
        </div>
      </igx-tab-content>
    </igx-tab-item>

    <!-- Equipment Requests Tab -->
    <igx-tab-item class="tab-item">
      <igx-tab-header>
        <igx-icon igxTabHeaderIcon>assignment</igx-icon>
        <span igxTabHeaderLabel>Equipment Requests management</span>
      </igx-tab-header>
      <igx-tab-content class="tab-item-content">
        <div class="requests-management-section">
          <h5>All Equipment Requests</h5>
          <p>Review and manage all equipment requests in the system.</p>
          
          <igx-grid 
            [data]="allRequests" 
            [allowFiltering]="true"
            height="500px"
            width="100%">
            
            <igx-column field="id" header="ID" [sortable]="true" [filterable]="true"></igx-column>
            
            <igx-column field="equipment.name" header="Equipment" [sortable]="true" [filterable]="true">
              <ng-template igxCell let-cell="cell">
                {{ cell.row.data.equipment?.name || 'N/A' }}
              </ng-template>
            </igx-column>
            
            <igx-column field="requestedAt" header="Requested" [sortable]="true" [filterable]="true">
              <ng-template igxCell let-cell="cell">
                {{ formatDate(cell.value) }}
              </ng-template>
            </igx-column>
            
            <igx-column field="start" header="Start" [sortable]="true" [filterable]="true">
              <ng-template igxCell let-cell="cell">
                {{ formatDate(cell.value) }}
              </ng-template>
            </igx-column>
            
            <igx-column field="end" header="End" [sortable]="true" [filterable]="true">
              <ng-template igxCell let-cell="cell">
                {{ formatDate(cell.value) }}
              </ng-template>
            </igx-column>
            
            <igx-column field="status" header="Status" [sortable]="true" [filterable]="true">
              <ng-template igxCell let-cell="cell">
                <span [class]="getStatusClass(cell.value)" class="status-badge">
                  {{ cell.value }}
                </span>
              </ng-template>
            </igx-column>
            
            <igx-column header="Actions" [sortable]="false" [filterable]="false">
              <ng-template igxCell let-cell="cell">
                @if (cell.row.data.status === 'Pending') {
                  <div class="action-buttons">
                    <button 
                      igxButton="contained" 
                      igxRipple 
                      (click)="approveRequest(cell.row.data)"
                      class="approve-btn"
                      title="Approve Request">
                      <igx-icon>check</igx-icon>
                      <span>Approve</span>
                    </button>
                    <button 
                      igxButton="contained" 
                      igxRipple 
                      (click)="rejectRequest(cell.row.data)"
                      class="reject-btn"
                      title="Reject Request">
                      <igx-icon>close</igx-icon>
                      <span>Reject</span>
                    </button>
                  </div>
                } @else {
                  <span class="action-status">{{ cell.row.data.status }}</span>
                }
              </ng-template>
            </igx-column>
          </igx-grid>
        </div>
      </igx-tab-content>
    </igx-tab-item>

    <!-- System Reports Tab -->
    <igx-tab-item class="tab-item">
      <igx-tab-header>
        <igx-icon igxTabHeaderIcon>analytics</igx-icon>
        <span igxTabHeaderLabel>System Reports</span>
      </igx-tab-header>
      <igx-tab-content class="tab-item-content">
        <div class="reports-section">
          <h3 class="section-title">Reports & Analytics</h3>
          <h5>System Statistics</h5>
          
          @if (usageStats) {
            <div class="stats-cards">
              <div class="stat-card">
                <h6>Total Equipment</h6>
                <span class="stat-value">{{ usageStats.total }}</span>
              </div>
              <div class="stat-card">
                <h6>Available</h6>
                <span class="stat-value available">{{ usageStats.available }}</span>
              </div>
              <div class="stat-card">
                <h6>Checked Out</h6>
                <span class="stat-value checked-out">{{ usageStats.checkedOut }}</span>
              </div>
              <div class="stat-card">
                <h6>Pending Requests</h6>
                <span class="stat-value pending">{{ usageStats.pending }}</span>
              </div>
              <div class="stat-card">
                <h6>Approved Requests</h6>
                <span class="stat-value approved">{{ usageStats.approved }}</span>
              </div>
            </div>
          } @else {
            <div class="loading-message">
              <p>Loading usage statistics...</p>
              <p><small>Debug: usageStats = {{ usageStats | json }}</small></p>
            </div>
          }
          
          <div class="export-section">
            <h6>Data Export</h6>
            <p>Export all system data for backup or analysis.</p>
            <button 
              igxButton="contained" 
              igxRipple 
              (click)="exportData()"
              class="export-btn">
              <igx-icon>download</igx-icon>
              Export All Data (CSV)
            </button>
          </div>
        </div>
      </igx-tab-content>
    </igx-tab-item>

  </igx-tabs>

  <igx-snackbar #snackbar></igx-snackbar>
</div>