<div class="my-requests-container">
  <div class="header-section">
    <h4>My Equipment Requests</h4>
    <br />
    <h5>View your equipment requests.</h5>
  </div>

  <igx-grid 
    #grid 
    [data]="myRequests" 
    [allowFiltering]="true"
    [filterMode]="'excelStyleFilter'"
    height="500px"
    width="100%">
    
    <igx-column field="id" header="Request ID" [sortable]="true" [filterable]="true" width="100px"></igx-column>
    
    <igx-column field="equipment.name" header="Equipment" [sortable]="true" [filterable]="true" >
      <ng-template igxCell let-cell="cell">
        <div class="equipment-info">
          <strong>{{ cell.row.data.equipment?.name || 'N/A' }}</strong>
          <br>
          <small>{{ cell.row.data.equipment?.type || '' }}</small>
        </div>
      </ng-template>
    </igx-column>
    
    <igx-column field="requestedAt" header="Requested" [sortable]="true" [filterable]="true" >
      <ng-template igxCell let-cell="cell">
        {{ formatDate(cell.value) }}
      </ng-template>
    </igx-column>
    
    <igx-column field="start" header="Start Date" [sortable]="true" [filterable]="true" >
      <ng-template igxCell let-cell="cell">
        {{ formatDate(cell.value) }}
      </ng-template>
    </igx-column>
    
    <igx-column field="end" header="End Date" [sortable]="true" [filterable]="true" >
      <ng-template igxCell let-cell="cell">
        {{ formatDate(cell.value) }}
      </ng-template>
    </igx-column>
    
    <igx-column field="status" header="Status" [sortable]="true" [filterable]="true" >
      <ng-template igxCell let-cell="cell">
        <span [class]="getStatusClass(cell.value)" class="status-badge">
          {{ cell.value }}
        </span>
      </ng-template>
    </igx-column>
    
    <igx-column field="notes" header="Notes" [sortable]="false" [filterable]="true" >
      <ng-template igxCell let-cell="cell">
        <span [title]="cell.value">{{ truncateText(cell.value, 50) }}</span>
      </ng-template>
    </igx-column>
    
    <igx-column field="approvedAt" header="Approved" [sortable]="true" [filterable]="true" >
      <ng-template igxCell let-cell="cell">
        {{ cell.value ? formatDate(cell.value) : '-' }}
      </ng-template>
    </igx-column>
    
    <igx-column field="returnedAt" header="Returned" [sortable]="true" [filterable]="true" >
      <ng-template igxCell let-cell="cell">
        {{ cell.value ? formatDate(cell.value) : '-' }}
      </ng-template>
    </igx-column>
    
    <igx-column header="Actions" [sortable]="false" [filterable]="false" >
      <ng-template igxCell let-cell="cell">
        @if (cell.row.data.status === 'Approved' && !cell.row.data.returnedAt) {
          <button 
            igxButton="outlined" 
            igxRipple 
            (click)="openReturnDialog(cell.row.data)"
            title="Mark as returned">
            <igx-icon>assignment_return</igx-icon>
            Return
          </button>
        }
        @if (cell.row.data.status === 'Pending') {
          <span class="pending-info">Awaiting approval</span>
        }
      </ng-template>
    </igx-column>
  </igx-grid>

  <!-- Return Dialog -->
  <igx-dialog #returnDialog [closeOnOutsideSelect]="true">
    <div igxDialogTitle>Return Equipment</div>
    <div igxDialogContent>
      @if (selectedRequest) {
        <div class="dialog-content">
          <h4>{{ selectedRequest.equipment?.name }}</h4>
          <p><strong>Request ID:</strong> {{ selectedRequest.id }}</p>
          
          <igx-input-group>
            <label igxLabel>Equipment Condition</label>
            <select igxInput [(ngModel)]="returnCondition">
              <option value="Excellent">Excellent</option>
              <option value="Good">Good</option>
              <option value="Fair">Fair</option>
              <option value="Damaged">Damaged</option>
            </select>
          </igx-input-group>
          
          <igx-input-group>
            <label igxLabel>Equipment Status</label>
            <select igxInput [(ngModel)]="returnStatus">
              <option value="Available">Available</option>
              <option value="UnderRepair">Under Repair</option>
              <option value="Unavailable">Unavailable</option>
            </select>
          </igx-input-group>
          
          <igx-input-group>
            <textarea igxInput [(ngModel)]="returnNotes" rows="3" placeholder="Any notes about the equipment condition..."></textarea>
            <label igxLabel>Return Notes (Optional)</label>
          </igx-input-group>
        </div>
      }
    </div>
    <div igxDialogActions>
      <button igxButton="flat" (click)="returnDialog.close()">Cancel</button>
      <button 
        igxButton="contained" 
        igxRipple 
        (click)="submitReturn()"
        [disabled]="!returnCondition || !returnStatus">
        Submit Return
      </button>
    </div>
  </igx-dialog>

  <igx-snackbar #snackbar></igx-snackbar>
</div>