<div class="column-layout profile-view-main-layout">
  <div class="column-layout profile-header-section">
    <h4 class="content">
      {{ isAdmin ? 'Admin Profile and Management' : 'My Profile and History' }}
    </h4>
    <p class="ig-typography__body-2 content">
      {{ isAdmin ? 'Manage your profile and assign user roles' : 'View your email, requests, and borrowing history' }}
    </p>
  </div>
  <div class="column-layout profile-form-layout">
    <igx-input-group type="box" class="email-input">
      <input type="email" [(ngModel)]="value" igxInput readonly />
      <label igxLabel>Email</label>
    </igx-input-group>
  </div>
  
  <!-- Admin view with tabs -->
  <div *ngIf="isAdmin" class="column-layout request-equipment-layout">
    <igx-tabs>
      <igx-tab-item>
        <igx-tab-header>
          <igx-icon>assignment_ind</igx-icon>
          <span>Assign Roles</span>
        </igx-tab-header>
        <igx-tab-content>
          <div class="column-layout role-assignment-section">
            <h4 class="request-equipment-title">
              Assign User Roles
            </h4>
            <form [formGroup]="roleAssignmentForm" (ngSubmit)="assignRole()" class="role-assignment-form">
              <div class="form-row">
                <igx-input-group type="box" class="form-input">
                  <input type="email" formControlName="email" igxInput />
                  <label igxLabel>User Email</label>
                </igx-input-group>
                <igx-select formControlName="role" class="form-select">
                  <label igxLabel>Role</label>
                  <igx-select-item *ngFor="let role of availableRoles" [value]="role">
                    {{ role }}
                  </igx-select-item>
                </igx-select>
                <button igxButton="contained" type="submit" [disabled]="!roleAssignmentForm.valid || isAssigning" class="assign-button">
                  {{ isAssigning ? 'Assigning...' : 'Assign Role' }}
                </button>
              </div>
            </form>
            <div *ngIf="assignmentMessage" class="assignment-message" [class.success]="assignmentMessage.includes('Successfully')" [class.error]="!assignmentMessage.includes('Successfully')">
              {{ assignmentMessage }}
            </div>
            
            <!-- Users list -->
            <div class="users-list-section">
              <h5>All Users</h5>
              <igx-grid [data]="allUsers" primaryKey="id" [allowFiltering]="true" filterMode="excelStyleFilter" width="100%" class="users-grid">
                <igx-column field="email" dataType="string" header="Email" [filterable]="true" [sortable]="true" [selectable]="false"></igx-column>
                <igx-column field="name" dataType="string" header="Name" [filterable]="true" [sortable]="true" [selectable]="false"></igx-column>
                <igx-column field="roles" dataType="string" header="Roles" [filterable]="true" [sortable]="true" [selectable]="false">
                  <ng-template igxCell let-cell="cell">
                    {{ getUserRoles(cell.row.data) }}
                  </ng-template>
                </igx-column>
                <igx-column field="emailConfirmed" dataType="boolean" header="Email Confirmed" [filterable]="true" [sortable]="true" [selectable]="false"></igx-column>
              </igx-grid>
            </div>
          </div>
        </igx-tab-content>
      </igx-tab-item>
      
      <igx-tab-item>
        <igx-tab-header>
          <igx-icon>list_alt</igx-icon>
          <span>My Requests</span>
        </igx-tab-header>
        <igx-tab-content>
          <div class="column-layout my-requests-section">
            <h4 class="request-equipment-title">
              My Equipment Requests
            </h4>
            @if (isLoadingRequests) {
              <div class="loading-indicator">Loading requests...</div>
            }
            <igx-grid [data]="myRequests" primaryKey="id" [allowFiltering]="true" filterMode="excelStyleFilter" width="100%" class="grid">
              <igx-column field="id" header="Request ID" [sortable]="true" [filterable]="true" width="100px"></igx-column>
              
              <igx-column field="equipment.name" header="Equipment" [sortable]="true" [filterable]="true" width="200px">
                <ng-template igxCell let-cell="cell">
                  <div class="equipment-info">
                    <strong>{{ cell.row.data.equipment?.name || 'N/A' }}</strong>
                    <br>
                    <small>{{ cell.row.data.equipment?.type || '' }}</small>
                  </div>
                </ng-template>
              </igx-column>
              
              <igx-column field="requestedAt" header="Requested" [sortable]="true" [filterable]="true" width="120px">
                <ng-template igxCell let-cell="cell">
                  {{ formatDate(cell.value) }}
                </ng-template>
              </igx-column>
              
              <igx-column field="start" header="Start Date" [sortable]="true" [filterable]="true" width="120px">
                <ng-template igxCell let-cell="cell">
                  {{ formatDate(cell.value) }}
                </ng-template>
              </igx-column>
              
              <igx-column field="end" header="End Date" [sortable]="true" [filterable]="true" width="120px">
                <ng-template igxCell let-cell="cell">
                  {{ formatDate(cell.value) }}
                </ng-template>
              </igx-column>
              
              <igx-column field="status" header="Status" [sortable]="true" [filterable]="true" width="120px">
                <ng-template igxCell let-cell="cell">
                  <span [class]="getStatusClass(cell.value)" class="status-badge">
                    {{ cell.value }}
                  </span>
                </ng-template>
              </igx-column>
              
              <igx-column field="notes" header="Notes" [sortable]="false" [filterable]="true" width="150px">
                <ng-template igxCell let-cell="cell">
                  <span [title]="cell.value">{{ truncateText(cell.value, 50) }}</span>
                </ng-template>
              </igx-column>
              
              <igx-column field="approvedAt" header="Approved" [sortable]="true" [filterable]="true" width="120px">
                <ng-template igxCell let-cell="cell">
                  {{ cell.value ? formatDate(cell.value) : '-' }}
                </ng-template>
              </igx-column>
              
              <igx-column field="returnedAt" header="Returned" [sortable]="true" [filterable]="true" width="120px">
                <ng-template igxCell let-cell="cell">
                  {{ cell.value ? formatDate(cell.value) : '-' }}
                </ng-template>
              </igx-column>
            </igx-grid>
          </div>
        </igx-tab-content>
      </igx-tab-item>
      
      <igx-tab-item>
        <igx-tab-header>
          <igx-icon>history</igx-icon>
          <span>Activity History</span>
        </igx-tab-header>
        <igx-tab-content>
          <div class="column-layout borrowing-history-section">
            <h4 class="request-equipment-title">
              Activity History
            </h4>
            @if (isLoadingHistory) {
              <div class="loading-indicator">Loading history...</div>
            }
            <igx-grid [data]="activityHistory" primaryKey="id" [allowFiltering]="true" filterMode="excelStyleFilter" width="100%" class="grid">
              <igx-column field="id" header="ID" [sortable]="true" [filterable]="true" width="80px"></igx-column>
              
              <igx-column field="action" header="Action" [sortable]="true" [filterable]="true" width="150px">
                <ng-template igxCell let-cell="cell">
                  <span [class]="getActionClass(cell.value)" class="action-badge">
                    {{ cell.value }}
                  </span>
                </ng-template>
              </igx-column>
              
              <igx-column field="equipmentName" header="Equipment" [sortable]="true" [filterable]="true" width="200px"></igx-column>
              
              <igx-column field="userName" header="User" [sortable]="true" [filterable]="true" width="150px"></igx-column>
              
              <igx-column field="timestamp" header="Date & Time" [sortable]="true" [filterable]="true" width="150px">
                <ng-template igxCell let-cell="cell">
                  {{ formatDate(cell.value) }}
                </ng-template>
              </igx-column>
              
              <igx-column field="details" header="Details" [sortable]="false" [filterable]="true" width="250px">
                <ng-template igxCell let-cell="cell">
                  <span [title]="cell.value">{{ cell.value || '-' }}</span>
                </ng-template>
              </igx-column>
            </igx-grid>
          </div>
        </igx-tab-content>
      </igx-tab-item>
    </igx-tabs>
  </div>
  
  <!-- Regular user view with tabs -->
  <div *ngIf="!isAdmin" class="column-layout request-equipment-layout">
    <igx-tabs>
      <igx-tab-item>
        <igx-tab-header>
          <igx-icon>list_alt</igx-icon>
          <span>My Requests</span>
        </igx-tab-header>
        <igx-tab-content>
          <div class="column-layout my-requests-section">
            <h4 class="request-equipment-title">
              My Equipment Requests
            </h4>
            @if (isLoadingRequests) {
              <div class="loading-indicator">Loading requests...</div>
            }
            <igx-grid [data]="myRequests" primaryKey="id" [allowFiltering]="true" filterMode="excelStyleFilter" width="100%" class="grid">
              <igx-column field="id" header="Request ID" [sortable]="true" [filterable]="true" width="100px"></igx-column>
              
              <igx-column field="equipment.name" header="Equipment" [sortable]="true" [filterable]="true" width="200px">
                <ng-template igxCell let-cell="cell">
                  <div class="equipment-info">
                    <strong>{{ cell.row.data.equipment?.name || 'N/A' }}</strong>
                    <br>
                    <small>{{ cell.row.data.equipment?.type || '' }}</small>
                  </div>
                </ng-template>
              </igx-column>
              
              <igx-column field="requestedAt" header="Requested" [sortable]="true" [filterable]="true" width="120px">
                <ng-template igxCell let-cell="cell">
                  {{ formatDate(cell.value) }}
                </ng-template>
              </igx-column>
              
              <igx-column field="start" header="Start Date" [sortable]="true" [filterable]="true" width="120px">
                <ng-template igxCell let-cell="cell">
                  {{ formatDate(cell.value) }}
                </ng-template>
              </igx-column>
              
              <igx-column field="end" header="End Date" [sortable]="true" [filterable]="true" width="120px">
                <ng-template igxCell let-cell="cell">
                  {{ formatDate(cell.value) }}
                </ng-template>
              </igx-column>
              
              <igx-column field="status" header="Status" [sortable]="true" [filterable]="true" width="120px">
                <ng-template igxCell let-cell="cell">
                  <span [class]="getStatusClass(cell.value)" class="status-badge">
                    {{ cell.value }}
                  </span>
                </ng-template>
              </igx-column>
              
              <igx-column field="notes" header="Notes" [sortable]="false" [filterable]="true" width="150px">
                <ng-template igxCell let-cell="cell">
                  <span [title]="cell.value">{{ truncateText(cell.value, 50) }}</span>
                </ng-template>
              </igx-column>
              
              <igx-column field="approvedAt" header="Approved" [sortable]="true" [filterable]="true" width="120px">
                <ng-template igxCell let-cell="cell">
                  {{ cell.value ? formatDate(cell.value) : '-' }}
                </ng-template>
              </igx-column>
              
              <igx-column field="returnedAt" header="Returned" [sortable]="true" [filterable]="true" width="120px">
                <ng-template igxCell let-cell="cell">
                  {{ cell.value ? formatDate(cell.value) : '-' }}
                </ng-template>
              </igx-column>
            </igx-grid>
          </div>
        </igx-tab-content>
      </igx-tab-item>
      
      <igx-tab-item>
        <igx-tab-header>
          <igx-icon>history</igx-icon>
          <span>Activity History</span>
        </igx-tab-header>
        <igx-tab-content>
          <div class="column-layout borrowing-history-section">
            <h4 class="request-equipment-title">
              Activity History
            </h4>
            @if (isLoadingHistory) {
              <div class="loading-indicator">Loading history...</div>
            }
            <igx-grid [data]="activityHistory" primaryKey="id" [allowFiltering]="true" filterMode="excelStyleFilter" width="100%" class="grid">
              <igx-column field="id" header="ID" [sortable]="true" [filterable]="true" width="80px"></igx-column>
              
              <igx-column field="action" header="Action" [sortable]="true" [filterable]="true" width="150px">
                <ng-template igxCell let-cell="cell">
                  <span [class]="getActionClass(cell.value)" class="action-badge">
                    {{ cell.value }}
                  </span>
                </ng-template>
              </igx-column>
              
              <igx-column field="equipmentName" header="Equipment" [sortable]="true" [filterable]="true" width="200px"></igx-column>
              
              <igx-column field="userName" header="User" [sortable]="true" [filterable]="true" width="150px"></igx-column>
              
              <igx-column field="timestamp" header="Date & Time" [sortable]="true" [filterable]="true" width="150px">
                <ng-template igxCell let-cell="cell">
                  {{ formatDate(cell.value) }}
                </ng-template>
              </igx-column>
              
              <igx-column field="details" header="Details" [sortable]="false" [filterable]="true" width="250px">
                <ng-template igxCell let-cell="cell">
                  <span [title]="cell.value">{{ cell.value || '-' }}</span>
                </ng-template>
              </igx-column>
            </igx-grid>
          </div>
        </igx-tab-content>
      </igx-tab-item>
    </igx-tabs>
  </div>
</div>
